# Place all the behaviors and hooks related to the matching controller here.
# All this logic will automatically be available in application.js.
# You can use CoffeeScript in this file: http://coffeescript.org/

$(document).on 'click', 'a.a-move-to', ->
  $tree = $('#tree')
  if selected_node = $tree.tree('getSelectedNode')
    container_id = selected_node.id
    jqXHR = $.raj.handleAjaxRequest
      type: 'post'
      url: "<%= ::Rails.application.routes.url_helpers.move_marked_things_path %>"
      data:
        parent_id: container_id
    jqXHR.success (data)->
        window.location = window.location
  else
    alert("Choose a container using the tree control to move selected objects inside of it.")
  return false

class InlineWidget
  selector: '#inline-widget'

  constructor: ->
    @widget = $(@selector)

  open: (html, callback) =>
    @widget.hide()
    @widget.html(html)
    callback ?= ->
      return
    @widget.slideDown(callback)

  close: (callback) =>
    @widget.slideUp =>
      @widget.html('')
      callback() if callback

  setupThingForm: =>
    $('#thing_name').autoWordComplete()
    $('#thing_name').focus()
    # $('#thing_name').putCursorAtEnd() # causes weirdness on iOS
    $('#show-more').click ->
      $('#more').toggle()
      $(this).hide()
      false

    $("div.tag-select input").each ->
      el = $(this)
      select2_data = Boxes.get_select2_tags_data()
      placeholder = "Click here to add tags"
      el.select2
        placeholder: placeholder
        allowClear: true
        minimumInputLength: 0
        minimumResultsForSearch: -1
        multiple: true
        data: select2_data

$(document).on "ready page:change", ->
  window.inlineWidget = new InlineWidget

# $(document).on 'click', 'a.a-new-thing', ->
#   a = $(this)
#   href = a.attr('href')
#   jqXHR = $.ajax
#     url: href
#     dataType: 'html'
#     type: 'get'
#   jqXHR.success (data) ->
#     $('#inline-widget').hide()
#     $('#inline-widget').html(data)
#     $('#inline-widget').slideDown()

#   false

$(document).on 'click', 'a.a-edit-thing, a.a-new-thing', ->
  a = $(this)
  href = a.attr('href')
  jqXHR = $.ajax
    url: href
    dataType: 'html'
    type: 'get'
  jqXHR.success (data) =>
    inlineWidget.open data, inlineWidget.setupThingForm
    $.raj.bind_hide_on_user_intent_events(a, inlineWidget.widget, inlineWidget.close)
  false

$(document).on 'click', 'a.a-close-widget', ->
  inlineWidget.close()